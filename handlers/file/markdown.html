{% extends base.html %}

{% block head %}
<script type="text/javascript" src="/static/lib/csv.js/csv.js"></script>
<script type="text/javascript" src="/static/lib/marked/marked.js"></script>
<script type="text/javascript" src="/static/js/marked-ext.js"></script>
<style>
.CodeMirror {
    width: 60rem;
    font-size:16px;
    height: auto;
}

#markdown-input {
    font-family: monospace;
}

.small {
    font-size: small;
}

</style>
{% end %}

{% block body %}

    {% include "file/header.html" %}

    <div style="">
    
    <h3>
        <span id="fileId" style="display:none;">{{file.id}}</span>
        <div style="display:none" id="renameDiv">
            <span><input id="newName"> </input></span> 
            <button onclick="renameFile()">重命名</button>
        </div>
        <div>
            <p><a id="oldName" href="javascript:switchRename()" style="color:blue">{{file.name}}</a></p>
            <p class="small">创建时间:{{file.sctime}}</p>
            <p class="small">修改时间:{{file.smtime}}</p>
        <div>
    </h3>

    {% include file/tags.html %}

    <span id="result" style="color:green"></span>
    
    </div>
    
    <hr/>

    <div>

        <div>
            {% if globals().get("download_csv") %} 
                <form action="/file/edit" method="POST" enctype="multipart/form-data">
                    <a href="/file/edit?option=download&id={{file.id}}">下载CSV</a> 
                    <input type="file" name="file" style="display: inline;"/>
                    <input type="text" name="option" value="upload" class="hide"/>
                    <input name="id" class="hide" value="{{file.id}}"/>
                    <button>上传</button>
                </form>
            {% end %}
        </div>
    </div>

    <form action="/file/update" method="POST">
        <div class="">
            <div class="">
                <div id="edit-btns">
                    <a href="/file/markdown/edit?id={{file.id}}">编辑</a>
                    <a href="javascript:medit()">移动编辑</a>
                </div>
            </div>

            <div style="padding-top:20px;">
                <div id="epiceditor" class="row">
                    <div id="markdown-input-div" class="col-md-6">
                        <textarea id="markdown-input" class="form-control" name="content" rows=50>{{?content}}</textarea>
                    </div>

                    <div id="markdown-output-div" class="col-md-12">

                    </div>
                </div>
            </div>
        </div>
    </form>

<div style="float:left;width:100%;">
{% if 'children' in globals() %}

{% if len(children) > 0 %}
    <h1>子页面</h1>
    <hr/>
{% end %}

<ul>
{% for child in children %}
    <li>
    [{{child.sctime}}] <a href="/file/edit?id={{child.id}}">{{child.name}}</a>
    </li>
{% end %}
</ul>
</div>
{% end %}

<script>
    function switchRename() {
        if ($("#renameDiv").css("display") == "none") {
            $("#oldName").hide();
            $("#renameDiv").css("display", "block");
            $("#newName").val($("#oldName").html());
        } else {
            $("#oldName").show();
            $("#renameDiv").css("display", "none");
        }
    }

    
    function delLink() {
        var r = confirm("确认删除 {{file.name}}?");
        if (r) {
            location.href="/file/update?option=del&id={{file.id}}";
        }
    }

        
    // autosize textarea rows
    
    var related = "{{file.related}}";
    var textContainer = document.getElementById("fileContent");
    function adjustRows(ele) {
        var text = ele.innerHTML;
        var rows = text.count('\n');
        ele.rows = rows + 10;
    }

    function edit() {
        location.href = "/file/markdown/edit?id={{file.id}}";
        /*
        $("#markdown-input-div").removeClass("hide");
        $("#markdown-output-div").removeClass("col-md-12").addClass("col-md-6");
        var height = Math.max(500, $("#markdown-output-div").height());
        $("#markdown-input").css({height:height+"px"});
        $("#edit-div").show();
        $("#edit-btns").hide();
        */
    }

    function medit() {
        $("#markdown-input-div").removeClass("hide").addClass("col-md-12");
        $("#markdown-output-div").removeClass("col-md-12").addClass("hide");
        var height = Math.max(500, $("#markdown-output-div").height());
        $("#markdown-input").css({height:height+"px"});
        $("#edit-div").show();
        $("#edit-btns").hide();
    }
    
    function preview() {
        if (!$("#markdown-input-div").hasClass("hide")) {
            $("#markdown-input-div").addClass("hide");
            $("#markdown-output-div").removeClass("hide").removeClass("col-md-6").addClass("col-md-12");
            $("#edit-div").hide();
            $("#edit-btns").show();
        }
    }
    
    function renameFile() {
        var fileId = $("#fileId").text();
        var oldName = $("#oldName").html();
        var newName = $("#newName").val();
        if (newName) {
            $.post("/file/update", {
                option: "rename",
                fileId: fileId,
                newName: newName
            }, function (msg) {
                var result = JSON.parse(msg);
                if (result.success)
                {
                    switchRename();
                    window.location.reload();
                } else {
                    alert("修改失败, " + result.msg);
                }
            })
        }
    }
    // set marked code highlight function
    // marked.defaults.highlight = highlight;

    function escape(html, encode) {
      return html
        .replace(!encode ? /&(?!#?\w+;)/g : /&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\n/g, '<br/>')
        .replace(/ /g, '&nbsp;');
    }

    $(function () {
        var old_content = $("#markdown-input-div").val();
        setInterval(function () {
            var input = $("#markdown-input").val();
            // not modified
            if (input == old_content) {
                return;
            }
            if ($("#markdown-output-div").hasClass("hide")) {
                return;
            }
            old_content = input;
            var outtext = marked.parse(input);
            $("#markdown-output-div").html(outtext); 
        }, 200);
        preview();
    })
</script>

<!-- GROUPS: {{file.groups}} -->
<!-- MD5: {{file.md5}} -->
{% end %}