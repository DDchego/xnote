{% extends base.html %}

{% block body %}

<div>
    <a href="/system/script_admin">脚本管理</a>|
    <a href="/system/crontab">定时任务管理</a>|
</div>

<table class="table col-md-12">

    <tr>
        <th>编号</th>
        <th>任务</th>
        <th>时间</th>
        <th>操作</th>
    </tr>
    {% set index = -1 %}
    {% for index, task in enumerate(task_list) %}
    {% set name = task.url %}
    <tr>
        <td>{{index+1}}</td>
        <td>
            <div style="word-wrap: break-word; width: 300px;">
                {{task.display_name}}
            </div>
        </td>
        <td>{{xutils.wday_map[task.tm_wday]}} 
            {% if task.tm_hour == "*" %} 每小时 {% else %} {{task.tm_hour}}时 {% end %}
            {% if task.tm_min == "*" %} 每分钟 {% else %} {{task.tm_min}}分 {% end %} 
        </td>
        <td>
            {% if task.id %}
            <input class="dialog-btn" type="button" value="编辑" 
                dialog-url="/file/memo/edit?id={{task.id}}" 
                href="/file/memo/edit?id={{task.id}}" />
            <input type="button" class="link-btn btn-danger" value="删除" href="/system/crontab/remove?id={{task.id}}" confirm-message="确认删除 {{task.display_name}} ?">
            {% end %}
        </td>
    </tr>
    {% end %}
</table>

<div class="col-md-12 top-offset-1">
    <input class="dialog-btn" type="button" value="添加" dialog-url="/file/memo/edit" />
</div>

<form method="POST" action="/system/crontab/add">
<table class="hide">
    <tr>
        <td>{{index+2}}</td>
        <td>
            <select id="url_type">
                <option value="script">脚本</option>
                <option value="url">URL</option>
            </select>
            <select name="script_url">
                {% for script_name in scripts %}
                    <option value="script://{{script_name}}">{{script_name}}</option>
                {% end %}
            </select>
            <input type="text" name="url" class="hide">
        </td>
        <td><select name="tm_wday">
            {% for wday in sorted(xutils.wday_map) %}
            <option value="{{wday}}">{{xutils.wday_map[wday]}}</option>
            {% end %}
        </select></td>
        <td>
            <select name="tm_hour">
                <option value="*">每小时</option>
                {% for hour in range(24) %}
                <option value="{{hour}}">{{hour}}</option>
                {% end %}
            </select>
        </td>
        <td>
            <select name="tm_min">
                <option value="*">每分钟</option>
                {% for tm_min in range(60) %}
                <option value="{{tm_min}}">{{tm_min}}</option>
                {% end %}
            </select>
        </td>
        <td><input type="submit" value="添加"></td>
    </tr>
</table>
</form>


<script type="text/javascript">
    $("#url_type").on("change", function (event) {
        console.log(event);
        var target = event.target;
        var value = $(target).val();
        if (value == "script") {
            $("select[name=script_url]").show();
            $("input[name=url]").val("").hide();
        } else {
            $("input[name=url]").show();
            $("select[name=script_url]").val("").hide();
        }
    })
</script>

{% end %}