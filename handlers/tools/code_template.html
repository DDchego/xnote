{% extends ../base.html %}
{% block head %}
    <script src="/static/js/array.js"></script>
    <script type="text/javascript" src="/static/js/Lexer.js"></script>
{% end %}

{% block body %}
<script>

function toCamel(name) {
	return name.replace(/_\w/g, function(m) {
		return m[1].toUpperCase();
	})
}

function bashformat(fmt, data) {
	var reg = /\$(\w+)/gi;
	return fmt.replace(reg, function (part) {
		var key = part.substring(1);
		if (key in data) {
			return data[key];
		}
		return part;
	});
}


function splitWords (string) {
    var rawWords = string.split(/[ \t\r\n]/);
    var words = [];
    for (var i = 0; i < rawWords.length; i++) {
        var item = rawWords[i];
        item = item.trim();
        if (item != "") {
            words.push(item);
        }
    };
    return words;
}


function gen_markdown_table (inputStr, opt) {
    
    inputStr = inputStr.replace("\r", "");
    var lines = inputStr.split("\n");

    var isFirstLine = true;
    var result = "";

    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var words = splitWords(line);
        if (words.length == 0) {
            continue;
        }
        if (isFirstLine) {
            result += "|" + words.join("|") + "|";
            result += "\n";
            var cols = [];
            for (var i = 0; i < words.length; i++) {
                cols.push("--")
            };
            result += "|" + cols.join("|") + "|\n";
            isFirstLine = false;
        } else {
            result += "|" + words.join("|") + "|\n";
        }
    };
    return result;
}


function gen_protobuf_dao(inputStr, option) {
	var lexer = new Lexer();
	var tokens = lexer.parse(inputStr);
	var out = "";
	for (var i = 0; i < tokens.length; i+=2) {
		var name = tokens[i].value;
		var type = tokens[i+1].value;
		var vars = {
		type: type,
		origin_name: name,
		name: toCamel(name),
		get: toCamel("get_" + name),
		set: toCamel("set_" + name)
		};
		var defines1 = bashformat("@Column(name = \"$origin_name\")\npublic $type $get() {\n return data.$get();\n}\n",
		vars);
		var defines2 = bashformat("public void $set($type $name){\n data.$set($name);\n}\n", vars);
		out += defines1 + defines2;
	}
	return out;
}

function gen_pojo(inputStr, option) {
	var lexer = new Lexer();
	var tokens = lexer.parse(inputStr);
	var out = "";
    var declare_list = [];

	for (var i = 0; i < tokens.length; i+=2) {
		var name = tokens[i].value;
		var type = tokens[i+1].value;
		var vars = {
		type: type,
		origin_name: name,
		name: toCamel(name),
		get: toCamel("get_" + name),
		set: toCamel("set_" + name)
		};
        var decl = bashformat("private $type $name;", vars);
		var defines1 = bashformat("public $type $get() {\n return this.$name;\n}\n",
		vars);
		var defines2 = bashformat("public void $set($type $name){\n this.$name = $name;\n}\n", vars);
        
        declare_list.push(decl);
		out += defines1 + defines2;
	}
	return declare_list.join("\n") + "\n" + out;
}

</script>
<div class="container col-md-6">
    <textarea id="input" rows=20 class="form-control" style="font-family:Consolas, Monospace"></textarea>
</div>
<div class="container col-md-6">
    <textarea id="output" rows=20 class="form-control" style="font-family:Consolas, Monospace"></textarea>
</div>

<div class="container">
    <p>
        转换方式
        <select id="option">
            <option value="gen_pojo">Java POJO</option>
            <option value="gen_protobuf_dao">Java ProtoBuf Dao</option>
            <!-- <option value="to_underscore">转为下划线风格</option> -->
        </select>
    </p>

    <p><button onclick="execute()">转换</button></p>
</div>

<div class="col-md-12">
    <h2>使用说明</h2>
    <table> 
        <tr>
            <th>类型</th>
            <th>语法</th>
            <th>示例</th>
        </tr>
        <tr>
            <td>POJO</td>
            <td><code>(name type)*</code> </td>
            <td><code>user_name String age int</code></td>
        </tr>
    </table>
</div>

<div class="col-md-12" id="error" style="color:red">
</div>
        
<script>

    function select(ident) {
        if (ident[0]=='#') {
            return document.getElementById(ident.substring(1));
        }
        if (ident[0]=='.') {
            return document.getElementsByClassName(ident.substring(1));
        }
    }

    function output(str) {
        document.getElementById("output").innerHTML = str;
    }
    
    function getInput() {
        return document.getElementById("input").value;
    }
    
    function Option () {
        this.getInstance = function () {
            return new Option();
        }
        
        this.getQuote = function () {
            var value = getRadioValue("quote");
            if (value == "0") return '"';
            else if (value == "1") return "'";
            return "";
        }

        this.getSeperator = function () {
            var value = select("#seperator").value;
            if (value == "\\n") return "\n";
            return value;
        }
        
        function getCase() {
            return getRadioValue("case");
        }
        
        this.isUpperCase = function () {
            return getCase() == "upper";
        }

        this.isLowerCase = function () {
            return getCase() == "lower";
        }

    }

    function execute() {
        var option = select('#option').value;
        console.log(option);
        var input = getInput();
        try {
            $("#error").html("");
            var str = window[option](input, new Option());
            output(str);
        } catch (e) {
            $("#error").html(e);
        }
        
    }
</script>

{% end %}